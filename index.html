<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
        }
        #map {
            /* configure the size of the map */
            width: 100vw;
            height: 50%;
        }
    </style>
    <title>Experiment Tool</title>
</head>
<body>
    <div id="map"> </div>
    <div id="inputArea">
        <h4> Coordinates <a id="highAccuracy"></a></h4>
        <a id="geoPosition"> </a>
        <button onclick="setWatcher()"> Update </button>
        <div id="details"></div>
    </div>
</body>

<script>
// Setup Map:
var map = L.map("map", { zoomControl: false }).setView([51.163361, 10.447683], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '',
    maxZoom: 18,
    tileSize: 512,
    zoomOffset: -1
}).addTo(map);

// Get Query Parameters:

var enableHighAccuracy = false;
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
if (urlParams.get('highAccuracy') != "")
{
    console.log("Enabling high accuracy");
    enableHighAccuracy = true;
    document.getElementById("highAccuracy").innerHTML = "(High accuracy)";
}

// Geolocation:

var marker, circle, lat, long, accuracy, timestamp, watcher;
var updateCount = 0;

function displayPosition(position) {
    updateCount += 1;
    lat = position.coords.latitude;
    long = position.coords.longitude;
    accuracy = position.coords.accuracy;
    timestamp = new Date(position.timestamp);

    const el = document.getElementById("geoPosition");
    // const options = { hour: "numeric" };
    el.innerHTML = `${lat.toFixed(5)}, ${long.toFixed(5)} (updated: ${timestamp.toLocaleTimeString('de-DE')}, count: ${updateCount})`;

    if (marker) {
        map.removeLayer(marker);
    }

    if (circle) {
        map.removeLayer(circle);
    }

    marker = L.marker([lat, long]);
    circle = L.circle([lat, long], { radius: accuracy });

    var featureGroup = L.featureGroup([marker, circle]).addTo(map);

    fillinFields(position.coords);
    map.fitBounds(featureGroup.getBounds());
}

function fillinFields(coords) {
    const target = document.getElementById("details");
    target.innerHTML = "";
    target.innerHTML += `Accuracy: ${coords.accuracy.toFixed(3)} <br>`;
    target.innerHTML += `Altitude: ${coords.altitude} <br>`;
    target.innerHTML += `Altitude-accuracy: ${coords.altitudeAccuracy} <br>`;
    target.innerHTML += `Heading: ${coords.heading} <br>`;
    target.innerHTML += `Speed: ${coords.speed} <br>`;
    
}

function setWatcher() {
    if (watcher)
        navigator.geolocation.clearWatch(watcher);
    watcher = navigator.geolocation.watchPosition(displayPosition,
        (e) => {console.error("ERROR:", e); window.alert(e.message);},
        {maximumAge: 5000, timeout: 5000, enableHighAccuracy});
}

if (!navigator.geolocation) {
    console.log("Your browser doesn't support geolocation feature!");
} else {
    setWatcher();
}
</script>